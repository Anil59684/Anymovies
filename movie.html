{% extends "base.html" %}
{% block content %}
  <h1>{{ movie.title }} ({{ movie.year }})</h1>
  <div class="meta">{{ movie.genre }} ‚Ä¢ ‚≠ê {{ (movie.ratings | length) and ((movie.ratings | map(attribute='rating') | sum / (movie.ratings|length)) * 20) | round(0) or 0 }}% ‚Ä¢ üëÅÔ∏è {{ movie.views }}</div>

  {% if movie.trailer %}
  <h3>Trailer</h3>
  <div class="playerWrap">
    <iframe width="100%" height="360" src="{{ movie.trailer }}" frameborder="0" allowfullscreen></iframe>
  </div>
  {% endif %}

  <h3>Watch</h3>
  {% if movie.source %}
    <div class="playerWrap" style="margin-bottom:10px;">
      <video controls width="100%" poster="{{ movie.poster }}">
        {% if movie.sourceType == 'hls' %}
          <source src="{{ movie.source }}" type="application/x-mpegURL">
        {% else %}
          <source src="{{ movie.source }}" type="video/mp4">
        {% endif %}
        Your browser does not support video.
      </video>
    </div>
  {% elif movie.external_watch %}
    <a class="btn" href="{{ movie.external_watch }}" target="_blank">Watch on external link</a>
  {% endif %}

  <div style="margin-top:12px;">
    <a class="btn" href="/download/{{ movie.slug }}">‚¨á Download</a>
  </div>

  <div style="margin-top:16px;">
    <h4>Rate this movie</h4>
    <form id="rateForm">
      <select id="ratingSelect">
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3" selected>3</option>
        <option value="4">4</option>
        <option value="5">5</option>
      </select>
      <button onclick="submitRating(event)" class="btn">Submit</button>
    </form>
  </div>

  <div style="margin-top:18px;">
    <h4>User Feedback</h4>
    <div id="comments">
      {% for c in movie.comments %}
        <div class="comment"><strong>{{ c.user }}</strong>: {{ c.text }}</div>
      {% endfor %}
    </div>

    <textarea id="commentText" rows="3" style="width:100%;"></textarea><br>
    <button onclick="postComment()" class="btn">Post Comment</button>
  </div>

  <script>
    async function postComment(){
      const text = document.getElementById('commentText').value;
      if(!text.trim()) return alert('Enter comment');
      const res = await fetch('/api/comment/{{ movie.slug }}', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ user: 'Anon', text })
      });
      if(res.ok) location.reload();
      else alert('Error');
    }
    async function submitRating(e){
      e.preventDefault();
      const val = document.getElementById('ratingSelect').value;
      await fetch('/api/rate/{{ movie.slug }}', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ user: localStorage.getItem('any_uid') || (localStorage.setItem('any_uid', crypto.randomUUID()), localStorage.getItem('any_uid')), rating: val })
      });
      alert('Thanks for rating');
    }
    window.addEventListener('load', ()=> fetch('/api/view/{{ movie.slug }}', { method:'POST' }));
  </script>
{% endblock %}